<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static',filename='css/ui.jqgrid-bootstrap.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static',filename='css/visual.css') }}" />

    <script>window.$ = window.jQuery = require('jquery');</script>
    <script src="//code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="{{ url_for('static',filename='app/js/i18n/grid.locale-en.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static',filename='app/js/jquery.jqGrid.min.js') }}"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
		$.jgrid.defaults.width = 1180;
		$.jgrid.defaults.responsive = true;
		$.jgrid.defaults.styleUI = 'Bootstrap';
    </script>
</head>

<body>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <table style="width: 100%; height: 100%; margin-top: 30px">
        <tr>
            <td rowspan="2" style="width: 30%; height: 50%; padding-top: 20px; padding-left: 20px">
                <div id="hbar_container"></div>
            </td>
            <td style="height: 20%; padding-top: 20px">Portion of topic</td>
        </tr>
        <tr>
            <td rowspan="2" style="height: 60%; padding-top: 20px; padding-right: 20px">
                <div id='layout-table'>
                    <table id="jqGrid"></table>
                    <div id="jqGridPager"></div>
                </div>
            </td>
        </tr>
        <tr>
            <td rowspan="2" style="width: 30%; height: 50%; padding-top: 20px; padding-left: 20px">
                <div id = 'entities_list'></div>
            </td>
        </tr>
        <tr>
            <td style="height: 20%; padding-top: 20px; padding-right: 20px">
                <div id='entities_render'></div>
            </td>
        </tr>
    </table>
</body>
<script type="text/javascript">
    var margin = {
        top: 20,
        right: 30,
        bottom: 30,
        left: 40
    }

    var bar_json = {{ bar_json | tojson }};
    var document_table_json = {{ document_table_json | tojson }};

    function get_entities(dataidx) {
        $.ajax({
            url: '/entities',
            type: 'POST',
            data: { idx: dataidx, data: JSON.stringify(document_table_json) },
            success: function(res) {
                dochtml = JSON.parse(res).dochtml
                $('#entities_render').html(dochtml)

                $('#entities_list').html($(dochtml).find("mark")[0])
            },
            error: function(error){
                console.log(error);
            }
        })
    }

    var hbarCanvas = d3.select("#hbar_container").attr("width", "90%")

    $(document).ready(function() {
        initializeHBarChart(bar_json['Topic1'].slice(0, 15), bar_json.max_width)

        tableData = document_table_json.rows
        initializeTable(tableData)
    })

    function initializeHBarChart(barData, max_width) {
        subCanvas = hbarCanvas.append('svg')
            .attr("id", 'bar')
            .attr('height', '400px')
            .attr('width', '400px')
            .append("g")
            .attr("transform", "translate(" + (margin.left + 20) + ", 0)")

        var x = d3.scaleBand()
            .rangeRound([0, 400])
            .padding(0.1)

        var y = d3.scaleBand()
            .rangeRound([0, 400])
            .padding(0.1)

        y.domain(barData.map(d => d['Term']))
        x.domain(barData.map(d => d['Freq']))

        subCanvas.append('g')
            .call(d3.axisLeft(y).tickSize(0))
            .call(subCanvas => subCanvas.select('.domain').remove())
            .selectAll('text')
            .style("text-anchor", "end")

        var hbars = subCanvas.selectAll('.bar')
            .data(barData, d => d['Term'])

        enteredBars = hbars.enter().append("rect")
            .attr("class", "bar")
            .attr("x", 0)
            .attr("y", function (d, i) {
                return 3 + 26 * i
            })
            .attr("height", y.bandwidth())
            .attr("width", d => Number(d['Total']) / max_width * 400)
            .attr("fill", '#A5C9E1')

        enteredBars2 = hbars.enter().append("rect")
            .attr("class", "bar")
            .attr("x", 0)
            .attr("y", function (d, i) {
                return 3 + 26 * i
            })
            .attr("height", y.bandwidth())
            .attr("width", d => Number(d['Freq']) / max_width * 400)
            .attr("fill", '#CC4A53')

        var mergedBars = enteredBars
            .merge(hbars)
            .transition().duration(1000)
            .attr("x", 0)
            .attr("y", function (d, i) {
                return 3 + 26 * i
            })
            .attr("height", y.bandwidth())
            .attr("width", d => Number(d['Total']) / max_width * 400)

        var mergedBars2 = enteredBars2
            .merge(hbars)
            .transition().duration(1000)
            .attr("x", 0)
            .attr("y", function (d, i) {
                return 3 + 26 * i
            })
            .attr("height", y.bandwidth())
            .attr("width", d => Number(d['Freq']) / max_width * 400)

        hbars.exit().remove()

        hbars.selectAll('.domain').remove()

    }

    function initializeTable(data) {
        var columns = ['document', 'topic_lda', 'topic_km', 'topic_dec'];
        var columnLabels = ['Document', 'Topic(lda)', 'Topic(KM)', 'Topic(DEC)'];
        var colw = [70, 10, 10, 10]
        var colModel = [];

        for (i = 0; i < columns.length; i++) {
            colModel.push({
                label: columnLabels[i],
                name: columns[i],
                width: colw[i]
            });
        }

        $("#jqGrid").jqGrid({
            data: data,
            datatype: "local",
            colModel: colModel,
            viewrecords: true,
            width: 1170,
            height: 570,
            rowNum: 15,
            autowidth: true,
            shrinktofit: true,
            pager: "#jqGridPager",
            onSelectRow: function(rowidx) {
                pgidx = $(".ui-pg-input").val()
                dataidx = $("#jqGrid").getGridParam("reccount") * (pgidx-1) + (rowidx * 1) - 1

                get_entities(dataidx)
            }
        });
        $('#jqGrid').jqGrid('navGrid', "#jqGridPager", {
            search: false,
            add: false,
            edit: false,
            del: false,
            view: true,
            refresh: true
        },
            {}, // edit options
            {}, // add options
            {}, // delete options
            {} // search options - define multiple search
        );
    }
</script>
</html>
