<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>2018-28420 Visualization Assignment 02: KBO data</title>
  <!-- DATA : KBO data(rank, win, tie, lose, winning rate, winning difference) from 1982 to 2017 except 1999, 2000 -->
  <style>
  text{
    fill: black;
    font: 11px sans-serif;
    text-anchor: middle;
  }
  </style>
</head>
<body>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <div id='data_manage'>
    <h1>KBO Ranking</h1>
    <select id='year' name='year'></select>
    <select id='year' name='year'></select>
    <select id='year' name='year'></select>
  </div>
  <svg id="table_container"></svg>
  <svg id="line_chart" width="50%", height="400"></svg>
  <svg id="bar_chart" width="50%", height="400"></svg>
  <script type="text/javascript">
    // python3 -m http.server

    let margin = 15
    let emptySpace = '\u00A0\u00A0'
    let tableWidth = 400
    let tableHeight = 400
    let columns = ['rank', 'team', 'W', 'D', 'L', 'win_rate', 'diff_game']
    // 1. load json
    // 2. add options data to selectors (year)
    let load = ()=>{
      let loaded_data = {}

      d3.json('data.json').then(function(data){
        // data is inserted in json format
        // must convert from string
        console.log(data)
        console.log(Object.values(data))

        data.forEach((v)=> {
          loaded_data[v['year']]=v['rankings']
        })
        addYearSelector(loaded_data)
        initializeTableHeader()
        initializeTableRows(loaded_data)
      })
      return loaded_data
    }
    const loaded_data = load()

    function addYearSelector(loaded_data){
      //insert year data
      let yearOptions = d3.select('#year')
                            .attr('class', 'select')
                            .on('change', redraw)
                            .selectAll('option')
                            .data(Object.keys(loaded_data))
                            .enter()
                            .append('option')
      yearOptions.text((d)=> d)
                  .attr('value', (d)=>d)
    }

    // 3. draw table header
    function initializeTableHeader(){
      let table = d3.select('#table_container')
                    .attr('width', tableWidth)
                    .attr('height', tableHeight)
                    .append('g')
                    .attr("transform", `translate(${margin}, ${margin})`)
                    .attr('id', 'table')
      let headers = table.append('g')
                        .attr('class', 'header')
                        .selectAll('g')
                        .data(columns)
                        .enter()
                        .append('g')
                        .attr('transform', (d,i)=> 'translate('+i*(tableWidth/columns.length)+',0)')

      headers.append('text')
            .merge(headers)
            .style('font-weight', 'bold')
            .text(d=>d)
    }

    function initializeTableRows(loaded_data){
      let selectedYear = d3.select('div')
                            .select('#year')
                            .property('value')

      let table_data = loaded_data[selectedYear].sort((a, b)=> a.rank-b.rank)
      console.log(table_data)
      let rows = d3.select('#table')
                    .append('g')
                    .attr('transform', (d,i)=> 'translate(0,20)')
                    .attr('class', 'rows')
                    .selectAll('g')
                    .data(table_data, get_key)

      let texts = rows.enter()
          .append('text')
          .merge(rows)
          .attr('y', (d,k)=> k*20)
          .attr('class', 'row')
          .style('width', '100%')
          .selectAll('text')
          .data((k) => columns.map(each_key => k[each_key]))

      texts.enter()
          .append('tspan')
          .attr('x', (d,k)=> k*(tableWidth/columns.length))
          .style('width', '100%')
          .text((d) => d)
    }

    let get_key = function(d) {
      console.log(d)
      return d['team']
    }

    function update_table(selected_data){
      let rows = d3.select('.rows').selectAll('text')
      // let origin_data = d3.select('.rows').selectAll('text').each(d=>d['team'])
      // console.log(origin_data)
      let update_rows = rows.data(selected_data, get_key)

      let exit_rows = update_rows.exit()

      exit_rows.transition()
              .duration(500)
              .style('opacity', 0)
      //        .remove()

      update_rows.transition()
                .delay(400)
                .duration(500)
                .attr('y', (d,k)=> k*20)
      // update_rows.selectAll('text')
      //             .data((k) => columns.map(each_key => k[each_key]))
      // update_rows.selectAll('text').selectAll('tspan')
                  // .text((d) => d)
      let enter_rows = update_rows.enter()
                                  .append('text')

      enter_rows.attr('y', (d,k)=> k*20)
                .attr('class', 'row')
                .style('width', '100%')
                .selectAll('text')
                .data((k) => columns.map(each_key => k[each_key]))
      let t_rows = update_rows.merge(enter_rows)
      let update_text = update_rows.selectAll('tspan')
      let enter_text  = enter_rows.enter()
                                  .append('tspan')
                                  .attr('x', (d,k)=> k*(tableWidth/columns.length))
                                  .style('width', '100%')
                                  .merge(update_text)
                                  .text((d) => d)

      let texts = update_text.merge(enter_text)
      texts.data((k) => columns.map(each_key => k[each_key]))
      // // trs.exit().remove()
    }

    function redraw(){
      let selectedYear = d3.select('div')
                            .select('#year')
                            .property('value')

      let table_data = loaded_data[selectedYear].sort((a, b)=> a.rank-b.rank)
      console.log(selectedYear)
      console.log(table_data)

      update_table(table_data)
    }

  </script>
</body>
</html>
