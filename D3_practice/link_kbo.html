<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>2018-28420 Visualization Assignment 02: KBO data</title>
  <!-- DATA : KBO data(rank, win, tie, lose, winning rate, winning difference) from 1982 to 2017 except 1999, 2000 -->
  <style>
  text{
    fill: black;
    font: 11px sans-serif;
    text-anchor: middle;
  }
  </style>
</head>
<body>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <div id='data_manage'>
    <h1>KBO Ranking</h1>
    <select id='year' name='year'></select>
    <select id='rate' name='rate'></select>
    <select id='bar_rate' name='bar_rate'></select>
  </div>
  <svg id="table_container"></svg>
  <svg id="line_chart" width="400", height="300"></svg>
  <svg id="bar_chart" width="400", height="300"></svg>
  <script type="text/javascript">
    // python3 -m http.server

    let margin = 15
    let tableWidth = 400
    let tableHeight = 300
    let columns = ['rank', 'team', 'W', 'D', 'L', 'win_rate', 'diff_game']
    let colors = d3.schemeCategory10
    colors = colors.concat(d3.schemeSet3)
    let teamColors = {}
    // 1. load json
    // 2. add options data to selectors (year)
    let totalData = {}

    let barChart = d3.select("#bar_chart")
    let lineChart = d3.select('#line_chart')

    d3.json('data.json').then(function(data){
      // data is inserted in json format
      // must convert from string
      console.log(data)
      console.log(Object.values(data))

      let uniqueTeams = []
      data.forEach((v)=>{
        totalData[v['year']]=v['rankings']
        v['rankings'].map(d=>d['team']).forEach(d=>{
          if (uniqueTeams.indexOf(d)<0){
            uniqueTeams.push(d)
          }
        })
      })
      uniqueTeams.forEach((t)=> {
        teamColors[t] = colors.pop()
      })

      addSelectors()
      let selectedYear = d3.select('div')
                            .select('#year')
                            .property('value')
      let tableData = totalData[selectedYear].sort((a, b)=> a.rank-b.rank)

      initializeTableHeader()
      initializeTableRows(tableData)
      initializeLineChart(tableData)
      initializeBar(tableData)
    })

    function addSelectors(){
      //insert year data
      let yearOptions = d3.select('#year')
                            .attr('class', 'select')
                            .on('change', redraw)
                            .selectAll('option')
                            .data(Object.keys(totalData))
                            .enter()
                            .append('option')
      yearOptions.text((d)=> d)
                  .attr('value', (d)=>d)

      let lineOptions = d3.select('#rate')
          .attr('class', 'select')
          .on('change', redrawLine)
          .selectAll('option')
          .data(['WR', 'DG'])
          .enter()
          .append('option').text(function (d) {
              return d;
          });

      let barOptions = d3.select('#bar_rate')
          .attr('class', 'select')
          .on('change', redrawBar)
          .selectAll('option')
          .data(['W', 'D', 'L'])
          .enter()
          .append('option').text(function (d) {
              return d;
          });
    }

    // 3. draw table header
    function initializeTableHeader(){
      let table = d3.select('#table_container')
                    .attr('width', tableWidth)
                    .attr('height', tableHeight)
                    .append('g')
                    .attr("transform", `translate(${margin}, ${margin})`)
                    .attr('id', 'table')
      let headers = table.append('g')
                        .attr('class', 'header')
                        .selectAll('g')
                        .data(columns)
                        .enter()
                        .append('g')
                        .attr('transform', (d,i)=> 'translate('+i*(tableWidth/columns.length)+',0)')

      headers.append('text')
            .merge(headers)
            .style('font-weight', 'bold')
            .text(d=>d)
    }

    function initializeTableRows(tableData){
      console.log(tableData)
      let rows = d3.select('#table')
                    .append('g')
                    .attr('transform', (d,i)=> 'translate(0,20)')
                    .attr('class', 'rows')
                    .selectAll('g')
                    .data(tableData, get_key)

      let texts = rows.enter()
          .append('text')
          .merge(rows)
          .attr('y', (d,k)=> k*20)
          .attr('class', 'row')
          .style('width', '100%')
          .selectAll('text')
          .data((k) => columns.map(each_key => k[each_key]))

      texts.enter()
          .append('tspan')
          .attr('x', (d,k)=> k*(tableWidth/columns.length))
          .style('width', '100%')
          .text((d) => d)
    }

    let get_key = function(d) {
      // console.log(d)
      return d['team']
    }

    function update_table(selectedData){
      let rows = d3.select('.rows').selectAll('text')
      let updateRows = rows.data(selectedData, get_key)
      let exit_rows = updateRows.exit()

      // fade exit rows with transition
      exit_rows.transition()
              .duration(700)
              .style('opacity', 0)
              .remove()

      // separate newly inserted rows
      let enterRows = updateRows.enter()
                                  .append('text')
      enterRows.transition()
              .duration(0)
              .style('opacity', 0)

      // relocate updated rows adjusted to the new rank
      updateRows.transition()
                .delay(700)
                .duration(700)
                .attr('y', (d,k)=> k*20)

      let changedRows = updateRows.data(selectedData, function(k){
                      return columns.map(each_key => k[each_key])})

      let updateText = changedRows.selectAll('tspan')

      let enterTexts = enterRows.merge(enterRows)
                                  .attr('y', (d,k)=> k*20)
                                  .attr('class', 'row')
                                  .style('width', '100%')
                                  .selectAll('text')
                                  .data((k) => columns.map(each_key => k[each_key]))

      enterTexts.enter()
          .append('tspan')
          .attr('x', (d,k)=> k*(tableWidth/columns.length))
          .style('width', '100%')
          .text((d) => d)

      let texts = updateText.data((k) => columns.map(each_key => k[each_key]))
      changedRows.selectAll('tspan')
                .transition()
                .delay(700)
                .duration(700)
                .text(d=>d)

      enterRows.transition()
              .delay(1000)
              .duration(900)
              .style('opacity', 1)
    }

    function redraw(){
      update_table(findCurrentYearData())
      //updateLine
      initializeLineChart(findCurrentYearData())
      //updateBar
    }

    function findCurrentYearData(){
      let selectedYear = d3.select('div')
                            .select('#year')
                            .property('value')
      return totalData[selectedYear].sort((a, b)=> a.rank-b.rank)
    }

    function redrawLine(){
      initializeLineChart(findCurrentYearData())
    }

    function redrawBar(){
      initializeBar(findCurrentYearData())
    }

    function initializeLineChart(tableData){
      let targetRate = d3.select('div')
                        .select('#rate')
                        .property('value')
      let targetRateV = targetRate === 'WR' ? 'win_rate' : 'diff_game'
      // data
      win_rate = {}
      tableData.map(d=>d['team']).forEach(team=>{
        let yearRecord = []

        d3.keys(totalData).forEach(k=>{
          let teamData = totalData[k].filter(y=> y['team']==team)
          if (teamData.length==0){
              yearRecord.push({'year':k,
                                'rate':null,//-1,
                                'team': team})
          }else{
            yearRecord.push({'year':k,
                              'rate':Number(teamData[0][targetRateV]),
                              'team': team})
            }
        })
        win_rate[team] = yearRecord
      })

      lineChart.selectAll("g").remove()

      let teamByYear = tableData.map((d)=>d['team']).map((t)=>win_rate[t])
      console.log(teamByYear)
      // line charts
      let xScale = d3.scaleLinear()
                      .domain([d3.min(d3.keys(totalData)), d3.max(d3.keys(totalData))])
                      .range([40, 400-15])

      let yRateScale = targetRate == 'WR' ? [0.15, 0.7] : [50, -15]
      let yScale = d3.scaleLinear()
                    // .domain([d3.min(tableData.map(d=>d['win_rate'])), d3.max(tableData.map(d=>d['win_rate']))]).nice()
                    .domain(yRateScale)
                    .range([300-30, 15]);

      let xAxis = (g)=>g.attr('transform', 'translate(0, 270)')
                        .call(d3.axisBottom(xScale).tickFormat((d,i)=> ''+d))

      let yAxis = (g)=>g.attr('transform', 'translate(40, 0)')
                        .call(d3.axisLeft(yScale))
                        .attr('text-anchor', 'start')

      lineChart.append("g")
                .call(xAxis)
      lineChart.append("g")
                .call(yAxis)
      lineChart.append("text")
              .attr("x", -(300 / 2) - 15)
              .attr("y", 15)
              .attr("transform", "rotate(-90)")
              .attr("text-anchor", "middle")
              .text(targetRateV);
      lineChart.append("text")
              .attr("x", 400 / 2 + 15 + 2*15)
              .attr("y", 300)
              .attr("text-anchor", "middle")
              .text("Year");

      let line = d3.line()
                    .defined(function(d){
                      return d.rate !== null
                    }).x((d)=> xScale(d.year))
                      .y((d)=> yScale(d.rate))

      let lines = lineChart.selectAll(".line")
          .data(teamByYear, function (d) {
            console.log(d)
              return d[0]['team']
          })

      let enteredLines = lines.enter().append("path")
                              .attr("class", function(d) {
                                  return d[0]['team'] + " line"
                              })
                              .attr("d", line)
                              .transition()
                              .duration(1000)
                              .style("opacity", 1)
                              .style("stroke", function (d) {
                                  return teamColors[d[0]['team']]
                              })
                              .style("stroke-width", 1.5)
                              .style("fill", "none")

      let mergedlines = lines.merge(enteredLines)
                              .transition()
                              .duration(1000)
                              .attr("d", line)
                              .style("stroke", function (d) {
                                  return teamColors[d[0]['team']]
                              })

      lines.exit().remove();

      lineChart.selectAll(".line")
          // .on("mouseover", handleMouseOver)
          // .on("mouseout", handleMouseOut);
  }

  function initializeBar(tableData) {
    let targetResult = d3.select('div')
        .select('#bar_rate')
        .property('value')

    barChart.selectAll("g").remove()

    var x = d3.scaleBand()
        .rangeRound([0, tableWidth])
        .padding(0.1);

    var y = d3.scaleBand()
        .rangeRound([0, tableHeight])
        .padding(0.1);

    x.domain(tableData.map(d => d['team']))
    y.domain(tableData.map(d => Number(d[targetResult])).sort(function(a, b){return a-b}).reverse())

    barChart.append("g")
        .attr("transform", "translate(0," + tableHeight + ")")
        .call(d3.axisBottom(x))

    barChart.append("g")
        .call(d3.axisLeft(y))
        .append("text")
        .attr("fill", "#000")
        .attr("y", 6)
        .attr("dy", "0.71em")
        .attr("text-anchor", "end")
        .text(targetResult);

    var bars = barChart.selectAll(".bar")
        .data(tableData, function (d) {
            return d['team']
        })

    enteredBars = bars.enter().append("rect")
        .attr("class", function(d) {
            return d.team + " bar"
        })
        .attr("x", function (d) {
            return x(d.team);
        })
        .attr("y", function (d) {
            return tableHeight - y(Number(d[targetResult]));
        })
        .attr("width", x.bandwidth())
        .attr("height", function (d) {
            return y(Number(d[targetResult]));
        })
        .attr("fill", function(d) {
            return teamColors[d.team]
        })
        .attr("opacity", function (d) {
            // maxi = previousData.length
            // out = 0.0
            // if (maxi === 0) {
            //     out = 1.0
            // } else {
            //     previousData.forEach((pd, j) => {
            //         if (pd['team'] === d['team']) {
            //             out = 1.0
            //         }
            //     })
            // }
            return 1
            // return out
        })

    var mergedBars = enteredBars
        .merge(bars)
        .transition().duration(1000)
        .attr("x", function (d) {
            return x(d.team);
        })
        .attr("y", function (d) {
            return y(Number(d[targetResult]));
        })
        .attr("width", x.bandwidth())
        .attr("height", function (d) {
            return tableHeight - y(Number(d[targetResult]));
        })
        .attr("fill", function(d) {
            return teamColors[d.team]
        })

    bars.exit().remove();

    barChart.selectAll(".bar")
        // .on("mouseover", handleMouseOver)
        // .on("mouseout", handleMouseOut);
  }

  function handleMouseOver(d, i) {
      selectedTeamLine = d3.select('#line_chart').selectAll(".line")._groups[0][i]
      selectedTeamBar = d3.select('#bar_chart').selectAll(".bar")._groups[0][i]
      selectedTeam = d3.select(selectedTeamBar).attr("class").split(" ")[0]

      d3.select(selectedTeamLine).style("stroke-width", 5)
      d3.select(selectedTeamBar).style("fill", darkerColor(teams[selectedTeam]))
      dataLength = tableCanvas.selectAll(".cell").selectAll("text")._groups.length / 7
      d3.range(0, dataLength).forEach(ti => {
          if (tableCanvas.selectAll(".cell").selectAll("text")._groups[ti*7+1][0].__data__ == selectedTeam) {
              d3.range(ti*7, ti*7+7).forEach(idx => {
                  d3.select(tableCanvas.selectAll(".cell").selectAll("text")._groups[idx][0]).style("font-weight", "bold")
              })
          }
      })
  }

  function handleMouseOut(d, i) {
      selectedTeamLine = d3.select('#line_chart').selectAll(".line")._groups[0][i]
      selectedTeamBar = d3.select('#bar_chart').selectAll(".bar")._groups[0][i]
      // selectedTeam = d3.select(selectedTeamBar).attr("class").split(" ")[0]

      d3.select(selectedTeamLine).style("stroke-width", 1.5)
      // d3.select(selectedTeamBar).style("fill", teams[selectedTeam])
      dataLength = tableCanvas.selectAll(".cell").selectAll("text")._groups.length / 7
      d3.range(0, dataLength).forEach(ti => {
          if (tableCanvas.selectAll(".cell").selectAll("text")._groups[ti*7+1][0].__data__ == selectedTeam) {
              d3.range(ti*7, ti*7+7).forEach(idx => {
                  d3.select(tableCanvas.selectAll(".cell").selectAll("text")._groups[idx][0]).style("font-weight", "")
              })
          }
      })
  }

  function darkerColor(originColor) {
      return d3.range(1,4).map(i => parseInt(originColor.slice((2*i-1), (2*i+1)), 16) + 20).map(c => c > 255 ? 255 : c).map(c => c.toString(16)).join("")
  }
  </script>
</body>
</html>
