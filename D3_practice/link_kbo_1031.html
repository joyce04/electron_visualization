<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title></title>
  <!-- DATA : KBO data(rank, win, tie, lose, winning rate, winning difference) from 1982 to 2017 except 1999, 2000 -->
  <style>
    text {
      fill: black;
      font: 11px sans-serif;
      text-anchor: middle;
    }

    .cell rect {
      fill: white;
    }

    .header rect {
      fill: white;
    }
  </style>
</head>
<body>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <div id='data_manage'>
    <h1>KBO Ranking</h1>
    <select id='year' name='year'></select>
    <select id='rate' name='rate'></select>
    <select id='result' name='result'></select>
  </div>
  <svg id="table_container"></svg>
  <svg id="line_chart"></svg>
  <svg id="bar_chart"></svg>
  <script type="text/javascript">
    var years = []
    var databyyear = {}
    let headers = ['rank', 'team', 'W', 'D', 'L', 'win_rate', 'diff_game']
    let colors = d3.schemeCategory10
    colors = colors.concat(d3.schemeSet3)
    var previousData = []
    var selectedData = []
    var teams = {}
    var margin = {
      top: 20,
      right: 30,
      bottom: 30,
      left: 40
    },
      width = 500 - margin.left - margin.right,
      height = 300 - margin.top - margin.bottom,
      fieldHeight = 20,
      fieldWidth = 60,
      transDuration = 1000

    var tableCanvas = d3.select("#table_container")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    var lineCanvas = d3.select("#line_chart")
                      .attr("width", width + margin.left + margin.right)
                      .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                      .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    var barCanvas = d3.select("#bar_chart")
                      .attr("width", width + margin.left + margin.right)
                      .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                      .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

    var headerGrp = tableCanvas.append("g").attr("class", "headerGrp")
    var rowsGrp = tableCanvas.append("g").attr("class", "rowsGrp")

    d3.json('data.json').then(function (data) {
      data.forEach((v) => {
        years.push(v['year'])
        databyyear[v['year']] = v['rankings']
      })
      years.map(y => databyyear[y].forEach(d => teams[d['team']] = '#0000000'))
      d3.keys(teams).forEach((k, i) => teams[k] = colors[i])

      initializeSelector(years)
      drawTableHeader()
      redrawAll(1)
    })
    function initializeSelector(years) {
      var yearOptions = d3.select('#year')
                          .attr('class', 'select')
                          .on('change', redrawAll)
                          .selectAll('option')
                          .data(years)
                          .enter()
                          .append('option')
                          .text(d => d)
      var lineOptions = d3.select('#rate')
                          .attr('class', 'select')
                          .on('change', drawLine)
                          .selectAll('option')
                          .data(['WR', 'DG'])
                          .enter()
                          .append('option')
                          .text(d => d)
      var barOptions = d3.select('#result')
                          .attr('class', 'select')
                          .on('change', drawBar)
                          .selectAll('option')
                          .data(['W', 'D', 'L'])
                          .enter()
                          .append('option').text(d => d)
    }
    function redrawAll(firstTime) {
      drawTable(firstTime)
      drawLine(firstTime)
      drawBar(firstTime)
    }
    function drawTableHeader() {
      var header = headerGrp.selectAll("g")
                            .data(headers)
                            .enter().append("g")
                            .attr("class", "header")
                            .attr("transform", (d, i) => "translate(" + i * fieldWidth + ",0)")
                            .on("click", d => drawTable(d))
      header.append("rect")
            .attr("width", fieldWidth - 1)
            .attr("height", fieldHeight)
      header.append("text")
            .attr("x", fieldWidth / 2)
            .attr("y", fieldHeight / 2)
            .attr("dy", ".35em")
            .text(String)
    }

    function drawTable(firstTime) {
      let selectedYear = d3.select('div').select('#year')
                            .property('value')
      selectedData = databyyear[selectedYear]
      // console.log(selectedData)
      var rows = rowsGrp.selectAll("g.row")
                        .data(selectedData, d => d['team'])

      var enteredRows = rows.enter().append("g")
                                    .attr("class", "row")
                                    .attr("transform", (d, i) => "translate(0," + (Number(d['rank']) - 1 + 1) * (fieldHeight + 1) + ")")
                                    .style("opacity", firstTime === 1 ? 1 : 0)

      var mergedRows = enteredRows.merge(rows)
                                  .transition().duration(transDuration)
                                  .attr("class", "row")
                                  .style("opacity", 1)

      rows.exit().remove()

      rowsGrp.selectAll("g.row")
              .on("mouseover", handleMouseOver)
              .on("mouseout", handleMouseOut)

      var cells = rowsGrp.selectAll("g.row").selectAll("g.cell")
                          .data(function (d) {
                            var vals = []
                            headers.forEach((h) => vals.push(d[h]))
                            return vals
                          })

      var enteredCells = cells.enter().append("g")
                              .attr("class", "cell")
                              .attr("transform", (d, i) => "translate(" + i * fieldWidth + ",0)")

      var mergedCells = enteredCells.merge(cells)
                                    .attr("class", "cell")
                                    .attr("transform", (d, i) => "translate(" + i * fieldWidth + ",0)")

      mergedCells.selectAll("rect").remove()
      mergedCells.selectAll("text").remove()

      mergedCells.append("rect")
                  .attr("width", fieldWidth - 1)
                  .attr("height", fieldHeight)

      mergedCells.append("text")
                  .attr("x", fieldWidth / 2)
                  .attr("y", fieldHeight / 2)
                  .attr("dy", ".35em")
                  .text(String)

      rowsGrp.selectAll("g.row")
              .transition().duration(transDuration)
              .attr("transform", (d, i) => "translate(0," + (Number(d['rank']) - 1 + 1) * (fieldHeight + 1) + ")")
              .on("end", function () {
                rowsGrp.selectAll("g.row")
                        .transition().duration(transDuration)
                        .style("opacity", 1.0)
                lineCanvas.selectAll(".line")
                          .transition().duration(transDuration)
                          .style("opacity", 1.0)
                barCanvas.selectAll(".bar")
                          .transition().duration(transDuration)
                          .style("opacity", 1.0)
            })
    }
    function drawLine(firstTime) {
      let targetRate = d3.select('div').select('#rate')
                          .property('value')
      let yAxis = targetRate == 'WR' ? [0.15, 0.7] : [50, -15]
      let rate = targetRate === 'WR' ? 'win_rate' : 'diff_game'
      var dataset = selectedData.map(sd => sd['team'])
                                .map(t => years.map(function (y) {
                                  return {
                                    'year': y,
                                    'rate': d3.max(databyyear[y].map(d => d['team'] === t ? d[rate] : -999)) > -999 ? d3.max(databyyear[y].map(d => d['team'] === t ? d[rate] : -999)) : null,
                                    'team': t,
                                    'type': rate
                                  }
                                }))
      console.log(dataset)
      lineCanvas.selectAll("g").remove()

      xScale = d3.scaleLinear()
                .domain([d3.min(years), d3.max(years)])
                .range([0, width])

      yScale = d3.scaleLinear()
                .domain(yAxis)
                .range([height, 0])

      line = d3.line()
              .defined(d => d['rate'] !== null)
              .x(d => xScale(d.year))
              .y(d => yScale(d.rate))

      lineCanvas.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(xScale).tickFormat((d,i)=> ''+d))
                .append("text")
                .attr("class", "xtext")
                .attr("x", (height / 2))
                .attr("y", -(margin.left-10))
                .attr("transform", "rotate(-90)")
                .attr("text-anchor", "middle")
                .text(rate)

      lineCanvas.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(0," + 0 + ")")
                .call(d3.axisLeft(yScale))
                .attr('text-anchor', 'end')
                .append("text")
                .attr("x", width / 2)
                .attr("y", height + margin.top + 10)
                .attr("text-anchor", "middle")
                .text("Year");

      let lines = lineCanvas.selectAll(".line")
                            .data(dataset, d => d[0]['team'])

      let enteredLines = lines.enter().append("path")
                                      .attr("class", d => d[0]['team'] + " line")
                                      .attr("d", line)
                                      .style("opacity", firstTime === 1 ? 1 : 0)
                                      .style("stroke", d => teams[d[0]['team']])

      let mergedlines = enteredLines.merge(lines)
                                    .transition().duration(transDuration)
                                    .attr("d", line)
                                    .style("stroke", d => teams[d[0]['team']])
                                    .style("stroke-width", 1.5)
                                    .style("fill", "none")

      lines.exit().remove()

      lineCanvas.selectAll(".line")
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut)
    }
    function drawBar(firstTime) {
      let targetResult = d3.select('div')
        .select('#result')
        .property('value')

      barCanvas.selectAll("g").remove()

      var x = d3.scaleBand()
        .rangeRound([0, width])
        .padding(0.1)

      var y = d3.scaleBand()
        .rangeRound([0, height])
        .padding(0.1)

      x.domain(selectedData.map(d => d['team']))
      y.domain(selectedData.map(d => Number(d[targetResult])).sort((a, b) => a - b).reverse())

      barCanvas.append("g")
              .attr("transform", "translate(0," + height + ")")
              .call(d3.axisBottom(x))

      barCanvas.append("g")
              .call(d3.axisLeft(y))
              .append("text")
              .attr("fill", "#000")
              .attr("y", -5)
              .attr("x", -5)
              .attr("text-anchor", "end")
              .text(targetResult)

      var bars = barCanvas.selectAll(".bar")
        .data(selectedData, d => d['team'])

      enteredBars = bars.enter().append("rect")
        .attr("class", d => d.team + " bar")
        .attr("x", d => x(d.team))
        .attr("y", d => y(Number(d[targetResult])))
        .attr("width", x.bandwidth())
        .attr("height", d => height - y(Number(d[targetResult])))
        .attr("fill", d => teams[d.team])
        .attr("opacity", firstTime === 1 ? 1 : 0)

      var mergedBars = enteredBars
        .merge(bars)
        .transition().duration(transDuration)
        .attr("x", d => x(d.team))
        .attr("y", d => y(Number(d[targetResult])))
        .attr("width", x.bandwidth())
        .attr("height", d => height - y(Number(d[targetResult])))
        .attr("fill", d => teams[d.team])

      bars.exit().remove()

      barCanvas.selectAll(".bar")
        .on("mouseover", handleMouseOver)
        .on("mouseout", handleMouseOut)
    }
    function handleMouseOver(d, i) {
      selectedTeamLine = lineCanvas.selectAll(".line")._groups[0][i]
      selectedTeamBar = barCanvas.selectAll(".bar")._groups[0][i]
      selectedTeamRow = rowsGrp.selectAll("g.row")._groups[0][i]
      selectedTeam = d3.select(selectedTeamBar).attr("class").split(" ")[0]

      d3.select(selectedTeamLine).style("stroke-width", 5)
      d3.select(selectedTeamBar).style("fill", darkerColor(teams[selectedTeam]))
      d3.select(selectedTeamRow).selectAll(".cell").selectAll("text").style("font-weight", "bold")
    }
    function handleMouseOut(d, i) {
      selectedTeamLine = lineCanvas.selectAll(".line")._groups[0][i]
      selectedTeamBar = barCanvas.selectAll(".bar")._groups[0][i]
      selectedTeamRow = rowsGrp.selectAll("g.row")._groups[0][i]
      selectedTeam = d3.select(selectedTeamBar).attr("class").split(" ")[0]

      d3.select(selectedTeamLine).style("stroke-width", 1.5)
      d3.select(selectedTeamBar).style("fill", teams[selectedTeam])
      d3.select(selectedTeamRow).selectAll(".cell").selectAll("text").style("font-weight", "")
    }
    function darkerColor(originColor) {
      return d3.range(1, 4).map(i => parseInt(originColor.slice((2 * i - 1), (2 * i + 1)), 16) + 20).map(c => c > 255 ? 255 : c).map(c => c.toString(16)).join("")
    }
  </script>
</body>
</html>
