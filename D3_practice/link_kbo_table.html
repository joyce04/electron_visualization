<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>2018-28420 Visualization Assignment 02: KBO data</title>
  <!-- DATA : KBO data(rank, win, tie, lose, winning rate, winning difference) from 1982 to 2017 except 1999, 2000 -->
  <style>
    /* .selected {
      fill: green;
    } */
  </style>
</head>
<body>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <div id='data_manage'>
    <h1>KBO Ranking</h1>
    <select id='year' name='year'></select>
    <select id='year' name='year'></select>
    <select id='year' name='year'></select>
  </div>
  <div id="table_container"></div>
  <svg id="line_chart" width="50%", height="400"></svg>
  <svg id="bar_chart" width="50%", height="400"></svg>
  <script type="text/javascript">
    // python3 -m http.server

    let margin = 10
    let emptySpace = '\u00A0\u00A0'

    // 1. load json
    // 2. add options data to selectors (year)
    let load = ()=>{
      let loaded_data = {}

      d3.json('data.json').then(function(data){
        // data is inserted in json format
        // must convert from string
        console.log(data)
        console.log(Object.values(data))

        data.forEach((v)=> {
          loaded_data[v['year']]=v['rankings']
        })
        addYearSelector(loaded_data)
        // d3.select('#year').property('value', Object.keys(loaded_data)[0])
        initialize_table(loaded_data)
      })
      return loaded_data
    }
    const loaded_data = load()

    function addYearSelector(loaded_data){
      //insert year data
      let yearOptions = d3.select('#year')
                            .attr('class', 'select')
                            .on('change', redraw)
                            // .attr('name', 'name-list')
                            .selectAll('option')
                            .data(Object.keys(loaded_data))
                            .enter()
                            .append('option')
      yearOptions.text((d)=> d)
                  .attr('value', (d)=>d)
    }

    // 3. draw table
    let columns = ['rank', 'team', 'W', 'D', 'L', 'win_rate', 'diff_game']//Object.keys(table_data[0])
    function initialize_table(loaded_data){
      let selectedYear = d3.select('div')
                            .select('#year')
                            .property('value')

      let table_data = loaded_data[selectedYear].sort((a, b)=> a.rank-b.rank)

      let table = d3.select('#table_container')
                    .append('table')
                    .attr("transform", `translate(${margin}, ${margin})`)
                    .attr('id', 'table')
      let thead = table.append('thead')
                        .append('tr')
                        .selectAll('th')
                        .data(columns)
      thead.enter()
            .append('th')
            .merge(thead)
            .text((k) => emptySpace+k+emptySpace)

      let tbody = table.append('tbody')
      // tr에 각 row data가 들어있음 {a:1, b:2, c:3}...
      let trs = tbody.selectAll('tr')
                      .data(table_data)

      trs.enter()
          .append('tr')
          .merge(trs)
          .selectAll('td')
          .data((k) => columns.map(each_key => k[each_key]))
          .enter()
          .append('td')
          .text((d) => emptySpace+d)
    }

    var get_key = function(d) {
      return d['team']
    }

    function update_table(selected_data){
      let tbody = d3.select('table').select('tbody')
      let update_trs = tbody
                  .selectAll('tr')
                  .data(selected_data, get_key)
      let exit_trs = update_trs.exit()
      exit_trs.transition()
              .duration(500)
              .style('opacity', 0)
              // .remove()

      let enter_trs = update_trs.enter()
                                .append('tr')
      // enter_trs.style('opacity', 0)

      update_trs.enter()
                .append('tr')

      let update_tds = update_trs.selectAll('td')
      let enter_tds = enter_trs.selectAll('td')
                                .enter()
                                .append('td')
                                .text(d=> emptySpace+d)
      let trs = update_trs.merge(enter_trs)

      console.log('*****')
      console.log(enter_trs)
      trs.sort(function(a,b){return a['rank']>b['rank']})
                .transition()
                .duration(500)

      // let trs = update_trs.enter().append('td')

      let tds = update_tds.merge(enter_tds)
      tds.data((k) => columns.map(each_key => k[each_key]))

      tds.transition()
          .duration(500)
          .text(function(d){return emptySpace+d})
      // tds.text(function(d){return emptySpace+d})


      // // trs.exit().remove()
    }

    function redraw(){
      let selectedYear = d3.select('div')
                            .select('#year')
                            .property('value')

      let table_data = loaded_data[selectedYear].sort((a, b)=> a.rank-b.rank)
      console.log(selectedYear)
      console.log(table_data)

      update_table(table_data)
    }

  </script>
</body>
</html>
