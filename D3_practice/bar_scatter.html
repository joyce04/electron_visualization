<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <!-- bar chart
  : for 10 categories(A-J) random values between 0 to 100
  : include X, Y axis
  : use scaleOrdinal (schemeCategory10)
  :-->
  <!-- scatter plot spec
  : update bnt click -> change location, color, radius (x, y scale should automatically change) via transition(smooth) -->
  <title>bar chart and scatter chart</title>
</head>
<body>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <h1>BAR CHART</h1>
  <svg id="bar_chart" style="width: 100%; height: 400px;"></svg>
  <div style="height:50px"></div>
  <h1>SCATTER PLOT</h1>
  <h5>1. 랜덤으로 cx, cy range를 지정하고<br>
  2. range 내에서 랜덤으로 cx, cy를 그리고 r는 20이내에서 랜덤으로, rgb는 각각 255이내에서 랜덤으로 데이터를 생성<br>
  3. x, y축은 각 cx, cy의 최소값 최대값을 기반으로 transition되며<br>
  4. 각 원도 새로 update, insert, remove된 데이터로 transition됩니다.</h5>
  <button onclick="drawScatterPlot()" type="button" name="change">update scatter data</button>
  <svg id="scatter_plot" style="width: 100%; height: 600px;"></svg>

  <script type="text/javascript">
  function getRandomNumber(range){
    return Math.floor((Math.random() * range) + 1);
  };

  // bar chart
  let categories = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
  let barData = []
  categories.forEach(c => {
    barData.push({index:c,
      score : getRandomNumber(100)});
    });
  console.log(barData)

  let colorScale = d3.scaleOrdinal(d3.schemeCategory10);

  let maxScore = 100
  let margin = 10,
      chart_margin = 25;
  let totalWidth = document.getElementById("bar_chart").clientWidth - 2*chart_margin - margin
  let totalHeight = document.getElementById("bar_chart").clientHeight - 2*chart_margin
  // console.log(totalWidth)
  let barWidth = Math.floor((totalWidth - categories.length * margin) / categories.length);

  let barChart = d3.select("#bar_chart");
  const chart = barChart.append("g")
                        .attr("transform", `translate(${chart_margin+margin}, ${chart_margin-margin})`);

// x and y scale
  const xScale = d3.scaleBand()
                  .rangeRound([0, totalWidth])
                  .domain(categories);
  const yScale = d3.scaleLinear()
                  .range([totalHeight, 0])
                  .domain([0, maxScore]);

  chart.append("g")
        .call(d3.axisLeft(yScale));
  chart.append("g")
        .attr("transform", `translate(0, ${totalHeight})`)
        .call(d3.axisBottom(xScale));

// text labels
  barChart.append("text")
          .attr("x", -(totalHeight / 2) - chart_margin)
          .attr("y", margin)
          .attr("transform", "rotate(-90)")
          .attr("text-anchor", "middle")
          .text("Y-Label");
  barChart.append("text")
          .attr("x", totalWidth / 2 + chart_margin + 2*margin)
          .attr("y", totalHeight + chart_margin + 2*margin)
          .attr("text-anchor", "middle")
          .text("X-Label");

  let bars = chart.selectAll("rect");

  function drawBarChart(){
    bars = chart.selectAll("rect");
    bars.data(barData)
        .enter()
        .append("rect")
        .merge(bars)
        // .attr("width", barWidth)
        .attr("width", xScale.bandwidth()-margin)
        .attr("height", (d) => d.score*(totalHeight/maxScore))
        .attr("fill", (d, i) => colorScale(i))
        .attr("x", (d, i) => i*margin+margin)
        .attr("y", (d, i) => (totalHeight - d.score*(totalHeight/maxScore)))
        .attr("transform", (s, i) => "translate("+i*barWidth+", 0)");

    // add event
    chart.selectAll("rect")
          .on("mouseover", function (actual, i){
          d3.select(this)
            .transition()
            .duration(100)
            .attr("opacity", 0.5);
    })
    .on("mouseout", function (actual, i){
      d3.select(this).attr("opacity", 1)
    });

    bars.data(barData).exit().remove();
  };

  drawBarChart()
  </script>
  <script type="text/javascript">
  // scatter plot
  function generateScatterData(){
    let scatterData = [];
    let range_max = parseInt(getRandomNumber(50)/10)*10 + 50
    console.log('range value :: ' + range_max)
    for (j of Array(100).fill(0).map((v,i) => i)) {
    scatterData.push({cx: getRandomNumber(range_max),
                      cy: getRandomNumber(range_max),
                      r: getRandomNumber(20),
                      rgb: [getRandomNumber(255), getRandomNumber(255), getRandomNumber(255)]})
                    };
    return scatterData;
  };

  let scatterPlot = d3.select("#scatter_plot");
  const scatter = scatterPlot.append("g")
                              .attr("transform", `translate(${chart_margin+margin}, ${chart_margin-margin})`);

  let scatterTotalHeight = document.getElementById("scatter_plot").clientHeight - 2*chart_margin
  let scatterXScale = d3.scaleLinear()
                        // .domain([0, d3.max(scatterData, (d) => d.cx)])
                        .domain([0, maxScore])
                        .range([0, totalWidth]);
  let scatterYScale = d3.scaleLinear()
                        // .domain([0, d3.max(scatterData, (d) => d.cy)])
                        .domain([0, maxScore])
                        .range([scatterTotalHeight, 0]);

  let xBottom = d3.axisBottom().scale(scatterXScale).ticks(10);
  let yLeft = d3.axisLeft().scale(scatterYScale).ticks(10);
  scatter.append("g")
          .attr("transform", `translate(0, 0)`)
          .attr('class', 'yaxis')
          .call(d3.axisLeft(scatterYScale));
  scatter.append("g")
          .attr("transform", `translate(0, ${scatterTotalHeight})`)
          .attr('class', 'xaxis')
          .call(d3.axisBottom(scatterXScale));

  function drawScatterPlot(){
    let scatterData = generateScatterData();

    let trans = d3.transition()
                  .duration(700)
                  .ease(d3.easeLinear);

    scatterXScale.domain([d3.min(scatterData, (d) => d.cx)
                        , d3.max(scatterData, (d) => d.cx)])
    // xBottom.scale(scatterXScale).ticks(10);

    scatterYScale.domain([d3.min(scatterData, (d) => d.cy)
                        , d3.max(scatterData, (d) => d.cy)])

    // yLeft.scale(scatterYScale).ticks(10);

    circles = scatter.selectAll("circle");
    circles.data(scatterData)
            .enter()
            .append("circle")
            .merge(circles)
            .transition(trans)
            .attr("cx", (d)=> scatterXScale(d.cx))
            .attr("cy", (d)=> scatterYScale(d.cy))
            .attr("r", (d)=> d.r)
            .attr("fill", (d)=> `rgb(${d.rgb[0]}, ${d.rgb[1]}, ${d.rgb[2]})`)
            .attr("opacity", 0.7);

    scatter.select('.xaxis')
          .transition()
          .duration(1500)
          .call(xBottom.scale(scatterXScale))

    scatter.select('.yaxis')
          .transition()
          .duration(1500)
          .call(yLeft.scale(scatterYScale))

    circles.exit().remove();
  };
  drawScatterPlot();
  </script>
</body>
</html>
