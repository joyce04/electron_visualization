<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>2018-28420 Visualization Assignment 02: KBO data</title>
    <!-- DATA : KBO data(rank, win, tie, lose, winning rate, winning difference) from 1982 to 2017 except 1999, 2000 -->
    <style>
        text {
            fill: white;
            font: 11px sans-serif;
            text-anchor: middle;
        }
    </style>
</head>

<body>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <div id='data_manage'>
        <h1>KBO Ranking</h1>
        <select id='year' name='year'></select>
    </div>
    <svg id="table_container"></svg>
    <svg id="line_chart" width="50%" , height="400"></svg>
    <svg id="bar_chart" width="50%" , height="400"></svg>
    <script type="text/javascript">
        var years = []
        var databyyear = {}
        let headers = ['rank', 'team', 'W', 'D', 'L', 'games', 'win_rate', 'diff_game']
        var previousData = []
        var selectedData = []

        var margin = {
                top: 20,
                right: 30,
                bottom: 30,
                left: 40
            },
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        var canvas = d3.select("#table_container")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var headerGrp = canvas.append("g").attr("class", "headerGrp");
        var rowsGrp = canvas.append("g").attr("class", "rowsGrp");

        var fieldHeight = 30;
        var fieldWidth = 90;

        var previousSort = null;

        d3.json('data.json').then(function(data) {
            // data is inserted in json format
            // must convert from string
            data.forEach((v) => {
                years.push(v['year'])
                databyyear[v['year']] = v['rankings']
            })

            initializeSelector(years)
            initializeTable()
        })

        function initializeSelector(years) {
            var options = d3.select('#year')
                .attr('class', 'select')
                .on('change', redraw)
                .selectAll('option')
                .data(years)
                .enter()
                .append('option').text(function(d) {
                    return d;
                });
        }

        function initializeTable() {
            let selectedYear = d3.keys(databyyear)[0]
            previousData = selectedData
            selectedData = databyyear[selectedYear]

            updateHeader()
            updateTable(null)
        }

        function redraw() {
            previousData = selectedData
            updateTable(null)
        }

        function updateHeader() {
            // create the table header  
            var header = headerGrp.selectAll("g")
                .data(headers)
                .enter().append("g")
                .attr("class", "header")
                .attr("transform", function(d, i) {
                    return "translate(" + i * fieldWidth + ",0)";
                })
                .on("click", function(d) {
                    return updateTable(d);
                });

            header.append("rect")
                .attr("width", fieldWidth - 1)
                .attr("height", fieldHeight);

            header.append("text")
                .attr("x", fieldWidth / 2)
                .attr("y", fieldHeight / 2)
                .attr("dy", ".35em")
                .text(String);
        }

        function updateTable(sortOn) {
            // Update Table by selected year's data
            let selectedYear = d3.select('div')
                .select('#year')
                .property('value')

            selectedData = databyyear[selectedYear]

            // fill the table   
            // select rows
            var rows = rowsGrp.selectAll("g.row").data(selectedData, function(d) {
                return [d['rank'], d['team'], d['games'], d['win_rate']]
            })
            console.log(rows)

            maxi = previousData.length

            // create rows  
            var rowsEnter = rows.enter().append("g")
                .attr("class", "row")
                .attr("transform", function(d, i) {
                    out = ""
                    if (maxi === 0) {
                        out = "translate(0," + (i + 1) * (fieldHeight + 1) + ")";
                    } else {
                        previousData.forEach((pd, j) => {
                            if (pd['team'] === d['team']) {
                                out = "translate(0," + (j + 1) * (fieldHeight + 1) + ")";
                            }
                        })
                    }

                    if (out === "") {
                        return "translate(0," + ((maxi++) + 1) * (fieldHeight + 1) + ")";
                    } else {
                        return out
                    }
                }).style("opacity", function(d) {
                    out = 0.0
                    if (maxi === 0) {
                        out = 1.0
                    } else {
                        previousData.forEach((pd, j) => {
                            if (pd['team'] === d['team']) {
                                out = 1.0
                            }
                        })
                    }
                    return out
                });

            rows.exit().remove()

            // select cells
            var cells = rowsEnter.selectAll("g.cell").data(function(d) {
                console.log(d)
                var vals = []
                headers.forEach((h) => vals.push(d[h]))
                return vals
            });

            // create cells
            var cellsEnter = cells.enter().append("g")
                .attr("class", "cell")
                .attr("transform", function(d, i) {
                    return "translate(" + i * fieldWidth + ",0)";
                });

            cellsEnter.append("rect")
                .attr("width", fieldWidth - 1)
                .attr("height", fieldHeight);

            cellsEnter.append("text")
                .attr("x", fieldWidth / 2)
                .attr("y", fieldHeight / 2)
                .attr("dy", ".35em")
                .text(String);

            // Finish Update and Remove data

            // Sort Data and Change Opacity
            rowsGrp.selectAll("g.row").transition().duration(2000)
                .attr("transform", function(d, i) {
                    return "translate(0," + (i + 1) * (fieldHeight + 1) + ")";
                })
                .on("end", function() {
                    rowsGrp.selectAll("g.row").transition().duration(1000)
                        .style("opacity", 1.0)
                });
        }
    </script>
</body>

</html>